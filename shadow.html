<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Shadow</title>
    <meta
      property="og:description"
      content="Initialize a map in an HTML element with MapLibre GL JS."
    />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@5.15.0/dist/maplibre-gl.css"
    />
    <script src="https://unpkg.com/maplibre-gl@5.15.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@7.3.1/turf.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      html,
      body,
      #map {
        height: 100%;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <script>
      const start = [-120, 36.7];
      const maxBbox = [-125, 32, -113.5, 42.5];

      const feature = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            geometry: {
              type: "MultiPolygon",
              coordinates: [
                [
                  [
                    [-114.72428, 32.71284],
                    [-114.68293, 32.7481],
                    [-114.57819, 32.73008],
                    [-114.53586, 32.73824],
                    [-114.52219, 32.80713],
                    [-114.47209, 32.84202],
                    [-114.458, 32.87671],
                    [-114.47375, 32.94058],
                    [-114.47375, 32.98526],
                    [-114.50173, 33.01941],
                    [-114.53654, 33.03538],
                    [-114.62734, 33.04095],
                    [-114.66682, 33.05415],
                    [-114.69675, 33.08936],
                    [-114.67302, 33.20498],
                    [-114.68317, 33.26277],
                    [-114.72133, 33.3063],
                    [-114.69814, 33.36841],
                    [-114.71738, 33.41661],
                    [-114.66833, 33.41966],
                    [-114.62585, 33.43714],
                    [-114.57934, 33.52012],
                    [-114.53586, 33.56187],
                    [-114.53449, 33.6168],
                    [-114.52241, 33.62757],
                    [-114.5173, 33.68475],
                    [-114.48806, 33.72513],
                    [-114.50322, 33.75428],
                    [-114.49453, 33.78804],
                    [-114.51027, 33.80413],
                    [-114.51599, 33.86912],
                    [-114.48976, 33.89058],
                    [-114.52219, 33.94143],
                    [-114.51594, 33.96363],
                    [-114.46074, 33.99947],
                    [-114.41694, 34.04847],
                    [-114.40864, 34.09109],
                    [-114.38215, 34.12371],
                    [-114.34587, 34.13321],
                    [-114.24384, 34.19371],
                    [-114.12739, 34.27967],
                    [-114.12514, 34.32779],
                    [-114.27888, 34.42076],
                    [-114.33542, 34.46333],
                    [-114.36379, 34.46705],
                    [-114.37707, 34.50039],
                    [-114.36721, 34.53013],
                    [-114.41974, 34.59595],
                    [-114.4289, 34.6429],
                    [-114.49426, 34.75359],
                    [-114.54235, 34.76788],
                    [-114.58002, 34.85689],
                    [-114.61696, 34.8793],
                    [-114.62822, 35.00357],
                    [-115.00002, 35.28907],
                    [-115.19379, 35.43785],
                    [-115.53493, 35.70572],
                    [-115.85627, 35.95809],
                    [-116.17758, 36.21043],
                    [-116.65954, 36.58892],
                    [-117.02621, 36.86451],
                    [-117.39289, 37.14014],
                    [-117.57619, 37.27793],
                    [-117.94289, 37.55354],
                    [-118.12621, 37.69134],
                    [-118.36044, 37.85481],
                    [-118.8289, 38.18179],
                    [-119.29733, 38.50877],
                    [-119.76579, 38.83575],
                    [-120.00002, 38.99922],
                    [-120.00014, 39.25181],
                    [-120.00024, 39.61817],
                    [-120.00029, 39.98453],
                    [-120.00041, 40.35088],
                    [-120.00046, 40.71726],
                    [-120.00056, 41.08362],
                    [-120.0006, 41.44998],
                    [-120.00075, 41.99954],
                    [-120.26235, 41.99954],
                    [-120.78544, 41.99954],
                    [-121.30861, 41.99954],
                    [-121.83171, 41.99954],
                    [-122.09328, 41.99954],
                    [-122.61642, 41.99954],
                    [-123.13952, 41.99954],
                    [-123.40109, 41.99954],
                    [-123.92419, 41.99954],
                    [-124.21452, 41.99954],
                    [-124.20222, 41.96039],
                    [-124.21884, 41.85001],
                    [-124.2629, 41.77643],
                    [-124.20111, 41.73931],
                    [-124.15946, 41.73667],
                    [-124.13988, 41.66429],
                    [-124.10277, 41.60261],
                    [-124.1031, 41.56656],
                    [-124.06835, 41.53925],
                    [-124.08202, 41.52147],
                    [-124.06216, 41.43588],
                    [-124.09093, 41.28946],
                    [-124.12426, 41.18181],
                    [-124.16289, 41.13908],
                    [-124.14688, 41.06017],
                    [-124.11141, 41.04166],
                    [-124.11041, 41.01525],
                    [-124.15497, 40.86173],
                    [-124.08446, 40.84837],
                    [-124.0874, 40.82516],
                    [-124.12186, 40.80738],
                    [-124.1755, 40.80356],
                    [-124.21384, 40.7014],
                    [-124.27387, 40.70005],
                    [-124.31163, 40.64623],
                    [-124.38583, 40.50952],
                    [-124.4092, 40.44382],
                    [-124.36621, 40.37745],
                    [-124.34828, 40.31891],
                    [-124.36351, 40.26148],
                    [-124.31938, 40.22461],
                    [-124.22, 40.16515],
                    [-124.18532, 40.12955],
                    [-124.11579, 40.10712],
                    [-124.08744, 40.07752],
                    [-124.08041, 40.03556],
                    [-124.03346, 40.01213],
                    [-123.97895, 39.9629],
                    [-123.9307, 39.90802],
                    [-123.90772, 39.86587],
                    [-123.85402, 39.83351],
                    [-123.82382, 39.71776],
                    [-123.79597, 39.69187],
                    [-123.78683, 39.59678],
                    [-123.76977, 39.54465],
                    [-123.81651, 39.444],
                    [-123.82492, 39.3473],
                    [-123.806, 39.32414],
                    [-123.76785, 39.19401],
                    [-123.73555, 39.15903],
                    [-123.69515, 39.05913],
                    [-123.68908, 39.0279],
                    [-123.72524, 38.96037],
                    [-123.71167, 38.91432],
                    [-123.64831, 38.84953],
                    [-123.59417, 38.80582],
                    [-123.53764, 38.77233],
                    [-123.43361, 38.68679],
                    [-123.4011, 38.64283],
                    [-123.34167, 38.58663],
                    [-123.33698, 38.56726],
                    [-123.25266, 38.51067],
                    [-123.17092, 38.47919],
                    [-123.12873, 38.44931],
                    [-123.08703, 38.39126],
                    [-123.06839, 38.34629],
                    [-123.06244, 38.2959],
                    [-123.02952, 38.31269],
                    [-122.97454, 38.26619],
                    [-122.96882, 38.23709],
                    [-122.93554, 38.21548],
                    [-122.85043, 38.1107],
                    [-122.86876, 38.11026],
                    [-122.96479, 38.1986],
                    [-122.94965, 38.14399],
                    [-123.016, 38.0007],
                    [-122.92111, 38.03487],
                    [-122.82143, 37.99767],
                    [-122.78024, 37.94813],
                    [-122.72774, 37.90304],
                    [-122.67239, 37.90657],
                    [-122.5737, 37.85591],
                    [-122.52843, 37.81637],
                    [-122.47756, 37.8251],
                    [-122.47805, 37.85968],
                    [-122.4388, 37.88208],
                    [-122.50344, 37.92481],
                    [-122.48035, 37.94182],
                    [-122.49254, 37.96979],
                    [-122.45424, 37.99781],
                    [-122.50605, 38.01717],
                    [-122.48249, 38.07688],
                    [-122.48742, 38.10483],
                    [-122.41063, 38.13385],
                    [-122.39652, 38.15323],
                    [-122.30068, 38.1082],
                    [-122.27146, 38.07451],
                    [-122.1843, 38.06479],
                    [-122.15848, 38.04345],
                    [-122.12108, 38.05988],
                    [-122.07549, 38.10051],
                    [-122.05517, 38.13373],
                    [-122.0003, 38.13731],
                    [-121.97127, 38.07492],
                    [-121.90831, 38.07884],
                    [-121.88253, 38.0569],
                    [-121.84612, 38.07251],
                    [-121.77985, 38.06137],
                    [-121.74206, 38.02945],
                    [-121.69933, 38.05085],
                    [-121.69004, 38.00912],
                    [-121.75108, 38.01944],
                    [-121.83712, 38.02306],
                    [-121.888, 38.04109],
                    [-122.00399, 38.05614],
                    [-122.08184, 38.0479],
                    [-122.14794, 38.02363],
                    [-122.22704, 38.05842],
                    [-122.27557, 38.0391],
                    [-122.29904, 38.0112],
                    [-122.33601, 38.00381],
                    [-122.39503, 37.97027],
                    [-122.4297, 37.96426],
                    [-122.41017, 37.93192],
                    [-122.36483, 37.90366],
                    [-122.32876, 37.90806],
                    [-122.2955, 37.83129],
                    [-122.32842, 37.80446],
                    [-122.33151, 37.78239],
                    [-122.24893, 37.7483],
                    [-122.25177, 37.72278],
                    [-122.19186, 37.70031],
                    [-122.16278, 37.66443],
                    [-122.14631, 37.57897],
                    [-122.09333, 37.50357],
                    [-122.06237, 37.5017],
                    [-122.03864, 37.4514],
                    [-122.10017, 37.45506],
                    [-122.13414, 37.49779],
                    [-122.18307, 37.50755],
                    [-122.1993, 37.53496],
                    [-122.23958, 37.54689],
                    [-122.25792, 37.57152],
                    [-122.35852, 37.59281],
                    [-122.38373, 37.63146],
                    [-122.37491, 37.65516],
                    [-122.39245, 37.71033],
                    [-122.35454, 37.73001],
                    [-122.38793, 37.79096],
                    [-122.41876, 37.81114],
                    [-122.46336, 37.8053],
                    [-122.51517, 37.78113],
                    [-122.49474, 37.66523],
                    [-122.50323, 37.60146],
                    [-122.51904, 37.58971],
                    [-122.52047, 37.53142],
                    [-122.50107, 37.50133],
                    [-122.46325, 37.49665],
                    [-122.44445, 37.43752],
                    [-122.40034, 37.35974],
                    [-122.41015, 37.26885],
                    [-122.41836, 37.25231],
                    [-122.40446, 37.19453],
                    [-122.36935, 37.17402],
                    [-122.35953, 37.15049],
                    [-122.28103, 37.09658],
                    [-122.2538, 37.05912],
                    [-122.15364, 36.97708],
                    [-122.106, 36.95576],
                    [-122.06087, 36.94881],
                    [-122.02121, 36.96267],
                    [-121.97424, 36.9552],
                    [-121.93724, 36.97831],
                    [-121.9056, 36.96913],
                    [-121.85993, 36.92748],
                    [-121.78981, 36.8062],
                    [-121.81426, 36.68324],
                    [-121.83793, 36.63561],
                    [-121.87, 36.60721],
                    [-121.93769, 36.63925],
                    [-121.978, 36.57477],
                    [-121.93462, 36.56123],
                    [-121.92753, 36.52385],
                    [-121.94631, 36.49189],
                    [-121.90417, 36.38454],
                    [-121.89563, 36.31393],
                    [-121.84542, 36.2724],
                    [-121.8356, 36.24917],
                    [-121.72914, 36.19814],
                    [-121.67792, 36.16268],
                    [-121.63016, 36.11306],
                    [-121.61822, 36.08443],
                    [-121.56674, 36.02012],
                    [-121.50668, 36.00326],
                    [-121.48998, 35.98225],
                    [-121.4632, 35.88673],
                    [-121.38712, 35.82143],
                    [-121.33723, 35.78653],
                    [-121.31459, 35.71372],
                    [-121.26915, 35.66421],
                    [-121.1694, 35.63692],
                    [-121.13087, 35.6007],
                    [-121.10181, 35.54967],
                    [-121.00536, 35.46066],
                    [-120.94619, 35.44629],
                    [-120.90818, 35.44824],
                    [-120.8711, 35.40531],
                    [-120.86675, 35.37099],
                    [-120.8314, 35.33609],
                    [-120.86783, 35.33039],
                    [-120.89765, 35.24977],
                    [-120.84979, 35.20291],
                    [-120.79084, 35.17902],
                    [-120.70637, 35.17422],
                    [-120.64489, 35.13939],
                    [-120.63073, 35.07388],
                    [-120.64238, 35.00087],
                    [-120.67284, 34.90752],
                    [-120.64461, 34.89511],
                    [-120.61557, 34.858],
                    [-120.61921, 34.81921],
                    [-120.64025, 34.75853],
                    [-120.60305, 34.70478],
                    [-120.60605, 34.67935],
                    [-120.64783, 34.58568],
                    [-120.62162, 34.55261],
                    [-120.57793, 34.55354],
                    [-120.50999, 34.52137],
                    [-120.47268, 34.45027],
                    [-120.4252, 34.45132],
                    [-120.29321, 34.46849],
                    [-120.13341, 34.47272],
                    [-120.09142, 34.45881],
                    [-120.00997, 34.46101],
                    [-119.95707, 34.43589],
                    [-119.92153, 34.4334],
                    [-119.87864, 34.40661],
                    [-119.78765, 34.41721],
                    [-119.73295, 34.39746],
                    [-119.61716, 34.42053],
                    [-119.56318, 34.41479],
                    [-119.53684, 34.39558],
                    [-119.45303, 34.3684],
                    [-119.39148, 34.31844],
                    [-119.2693, 34.25496],
                    [-119.26019, 34.21712],
                    [-119.21709, 34.1455],
                    [-119.1937, 34.14174],
                    [-119.12865, 34.10055],
                    [-119.0897, 34.10048],
                    [-119.00808, 34.06612],
                    [-118.93681, 34.0432],
                    [-118.8526, 34.03366],
                    [-118.80697, 33.99941],
                    [-118.7834, 34.02184],
                    [-118.67566, 34.03812],
                    [-118.54406, 34.03889],
                    [-118.48266, 33.99901],
                    [-118.44465, 33.94941],
                    [-118.39139, 33.83594],
                    [-118.39572, 33.80565],
                    [-118.42757, 33.77373],
                    [-118.41204, 33.74168],
                    [-118.36229, 33.73569],
                    [-118.30088, 33.70985],
                    [-118.25455, 33.7654],
                    [-118.22151, 33.7709],
                    [-118.15258, 33.75877],
                    [-118.09054, 33.73098],
                    [-117.97851, 33.63597],
                    [-117.93022, 33.60792],
                    [-117.88025, 33.59288],
                    [-117.77652, 33.52936],
                    [-117.73522, 33.48477],
                    [-117.65437, 33.44196],
                    [-117.5963, 33.39045],
                    [-117.50884, 33.33521],
                    [-117.36191, 33.16594],
                    [-117.32216, 33.1085],
                    [-117.29808, 33.0359],
                    [-117.27477, 32.99348],
                    [-117.25364, 32.88508],
                    [-117.25987, 32.85407],
                    [-117.2836, 32.83765],
                    [-117.25756, 32.78424],
                    [-117.25748, 32.70173],
                    [-117.16637, 32.6695],
                    [-117.13701, 32.61576],
                    [-117.12512, 32.53167],
                    [-116.52947, 32.57633],
                    [-116.08823, 32.60966],
                    [-115.79406, 32.63196],
                    [-115.27929, 32.67082],
                    [-114.72428, 32.71284],
                  ],
                ],
                [
                  [
                    [-118.35877, 32.82783],
                    [-118.48356, 32.9216],
                    [-118.54505, 32.98561],
                    [-118.57716, 33.03246],
                    [-118.60722, 33.03086],
                    [-118.54692, 32.91875],
                    [-118.5086, 32.87647],
                    [-118.49915, 32.85063],
                    [-118.42501, 32.80242],
                    [-118.35877, 32.82783],
                  ],
                ],
                [
                  [
                    [-119.4886, 33.26719],
                    [-119.5321, 33.28628],
                    [-119.5727, 33.26476],
                    [-119.54419, 33.23132],
                    [-119.47294, 33.21532],
                    [-119.43446, 33.23132],
                    [-119.4886, 33.26719],
                  ],
                ],
                [
                  [
                    [-118.51565, 33.42301],
                    [-118.48635, 33.41597],
                    [-118.48958, 33.3585],
                    [-118.46359, 33.32351],
                    [-118.3748, 33.31951],
                    [-118.32603, 33.29863],
                    [-118.30867, 33.33642],
                    [-118.35513, 33.37735],
                    [-118.36921, 33.40839],
                    [-118.44479, 33.42858],
                    [-118.51775, 33.45978],
                    [-118.53586, 33.47728],
                    [-118.60391, 33.47659],
                    [-118.57285, 33.43791],
                    [-118.51565, 33.42301],
                  ],
                ],
                [
                  [
                    [-120.04414, 34.03727],
                    [-120.09667, 34.01786],
                    [-120.14548, 34.0245],
                    [-120.17096, 34.00741],
                    [-120.21762, 34.01054],
                    [-120.21024, 33.97249],
                    [-120.17561, 33.92223],
                    [-120.10989, 33.89314],
                    [-119.99963, 33.94148],
                    [-119.96883, 33.94112],
                    [-119.98041, 33.98347],
                    [-120.03397, 33.98958],
                    [-120.04414, 34.03727],
                  ],
                ],
                [
                  [
                    [-120.34458, 34.04649],
                    [-120.36221, 34.07168],
                    [-120.41519, 34.03247],
                    [-120.36044, 34.01476],
                    [-120.34458, 34.04649],
                  ],
                ],
                [
                  [
                    [-119.52943, 34.02525],
                    [-119.56493, 34.05532],
                    [-119.61008, 34.03965],
                    [-119.63318, 34.01364],
                    [-119.68536, 34.01987],
                    [-119.71184, 34.04225],
                    [-119.75926, 34.05581],
                    [-119.807, 34.05195],
                    [-119.85641, 34.07055],
                    [-119.90463, 34.0743],
                    [-119.91912, 34.05754],
                    [-119.87722, 34.03248],
                    [-119.88707, 34.00878],
                    [-119.85077, 33.96738],
                    [-119.75924, 33.95734],
                    [-119.71951, 33.95913],
                    [-119.65768, 33.98606],
                    [-119.55952, 33.99431],
                    [-119.52943, 34.02525],
                  ],
                ],
              ],
            },
          },
        ],
      };

      const blank = {
        version: 8,
        sources: {},
        light: {
          intensity: 0,
        },
        projection: {
          type: "mercator",
        },
        layers: [],
      };

      const map = new maplibregl.Map({
        container: "map",
        style: blank,
        center: start,
        zoom: window.innerWidth > 600 ? 5 : 5,
        maplibreLogo: false,
        attributionControl: false,
        maxZoom: 7,
        minZoom: 3,
        doubleClickZoom: false,
        bounds: maxBbox,
        maxBounds: [
          maxBbox[0] - 10,
          maxBbox[1] - 10,
          maxBbox[2] + 10,
          maxBbox[3] + 10,
        ],
      });

      map.on("load", () => {
        initLayers();
        map.addControl(
          new maplibregl.AttributionControl({
            customAttribution:
              "Maplibre, Imagery: <a href='https://www.shadedreliefarchive.com/' target='_blank'>Shaded Relief Archive</a>",
          })
        );
      });

      function initLayers() {
        baseMapLayers();
        const rings = buildRings();
        addShadow(rings);
      }

      function baseMapLayers() {
        map
          .addSource("raster-source", {
            type: "image",
            url: "california.png",
            coordinates: [
              [-124.4040415, 41.9931151],
              [-114.1292401, 41.9931151],
              [-114.1292401, 32.5343629],
              [-124.4040415, 32.5343629],
            ],
          })
          .addLayer({
            id: "raster-layer",
            type: "raster",
            source: "raster-source",
            paint: {
              "raster-opacity": 1,
            },
          });

        map
          .addSource("shape-source", {
            type: "geojson",
            data: feature,
          })
          .addLayer({
            id: "shape-line",
            type: "line",
            source: "shape-source",
            layout: {
              "line-join": "round",
              "line-cap": "round",
            },
            paint: {
              "line-color": "rgba(0,0,0,0.85)",
              "line-width": 1,
            },
          });

        map
          .addSource("point-source", {
            type: "geojson",
            data: {
              type: "FeatureCollection",
              features: [
                {
                  type: "Feature",
                  geometry: {
                    type: "Point",
                    coordinates: start, // Example coordinates [lng, lat]
                  },
                  properties: {
                    title: "Calif.",
                  },
                },
              ],
            },
          })
          .addLayer({
            id: "symbols-layer",
            type: "symbol",
            source: "point-source", // Reference the source ID
            layout: {
              "text-field": ["get", "title"],
              "text-font": ["courier"],
              "text-size": ["interpolate", ["linear"], ["zoom"], 4, 12, 5, 20],
              "text-transform": "uppercase",
              "text-letter-spacing": 0.1,
              "text-anchor": "center",
              "text-offset": [0, 0],
            },
            paint: {
              "text-color": "rgba(255,255,255,1)",
              "text-halo-color": "rgba(0,0,0,0.15)",
              "text-halo-width": 1.25,
              "text-halo-blur": 0.75,
            },
          });
      }

      function buildRings() {
        const shadowDetail = 30;
        const bufferOptions = {
          units: "miles",
          steps: 5,
        };
        const buffers = [];
        for (let i = 1; i <= shadowDetail; i++) {
          const buf = turf.buffer(feature, i * 0.85, bufferOptions);
          buf.features[0].properties = { opacity: 1 - i / shadowDetail };
          buffers.push(buf);
        }
        return {
          type: "FeatureCollection",
          features: buffers.flatMap((buffer) => buffer.features),
        };
      }

      function addShadow(d) {
        for (const [key, value] of Object.entries(d.features)) {
          const sourceName = `layer-${key}-source`;
          const fillName = `fill-${key}-layer`;
          const lineName = `line-${key}-layer`;
          map
            .addSource(sourceName, {
              type: "geojson",
              data: value,
              generateId: true,
            })
            .addLayer(
              {
                id: lineName,
                type: "fill",
                source: sourceName,
                paint: {
                  "fill-color": "rgba(0,0,0,0.015)",
                  "fill-opacity": ["get", "opacity"],
                  "fill-outline-color": "rgba(0,0,0,0)",
                  "fill-antialias": false,
                },
              },
              "raster-layer"
            );
        }
      }
    </script>
  </body>
</html>
